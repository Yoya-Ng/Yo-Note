// src/components/user/ProfilePage.astro
---
interface Props {
  isLoggedIn?: boolean;
  user?: {
    id: string;
    username: string;
    email: string;
    avatar?: string;
    role: 'guest' | 'user' | 'premium' | 'admin';
    joinDate: string;
    lastLogin: string;
  };
}

const { isLoggedIn = false, user } = Astro.props;

const formatRole = (role: string): string => {
  const roleMap: Record<string, string> = {
    guest: 'è¨ªå®¢',
    user: 'æ™®é€šç”¨æˆ¶',
    premium: 'é«˜ç´šæœƒå“¡',
    admin: 'ç®¡ç†å“¡'
  };
  return roleMap[role] || role;
};

const formatDate = (dateStr: string): string => {
  return new Date(dateStr).toLocaleDateString('zh-TW');
};

const formatFullDate = (dateStr: string): string => {
  return new Date(dateStr).toLocaleString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
};

const calculateAccountAge = (): number => {
  if (!user) return 0;
  const joinDate = new Date(user.joinDate);
  const today = new Date();
  const diff = today.getTime() - joinDate.getTime();
  return Math.floor(diff / (1000 * 60 * 60 * 24));
};

const badgeClass = (role: string): string => {
  const classes: Record<string, string> = {
    premium: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
    admin: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
    user: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
  };
  return classes[role] || '';
};
---

<div class="profile-container section container">
  {!isLoggedIn ? (
    <div class="not-logged-in glass rounded-lg p-8 text-center">
      <p class="text-lg mb-4">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹æ‚¨çš„å€‹äººè³‡æ–™</p>
      <a href="/login" class="btn btn-primary">å‰å¾€ç™»å…¥</a>
    </div>
  ) : user ? (
    <div class="profile-content">
      {/* é ­éƒ¨ */}
      <section class="profile-header glass rounded-lg p-8 mb-6">
        <div class="flex items-center gap-6">
          <div class="avatar">
            <img 
              src={user.avatar || '/default-avatar.png'} 
              alt={user.username}
              class="w-24 h-24 rounded-full border-4 border-primary"
            />
          </div>
          <div class="user-info flex-1">
            <h1 class="text-3xl font-bold mb-2">{user.username}</h1>
            <p class="text-lg mb-3">{user.email}</p>
            <div class="flex gap-4 flex-wrap">
              <span class={`badge inline-block px-3 py-1 rounded-full text-sm font-semibold ${badgeClass(user.role)}`}>
                {formatRole(user.role)}
              </span>
              <span class="text-gray-500">
                åŠ å…¥æ–¼ {formatDate(user.joinDate)}
              </span>
            </div>
          </div>
        </div>
      </section>

      {/* çµ±è¨ˆæ•¸æ“š */}
      <section class="stats-grid grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="stat-card glass rounded-lg p-4">
          <h3 class="text-sm text-gray-500">å¸³æˆ¶ç‹€æ…‹</h3>
          <p class="text-2xl font-bold">
            {user.role === 'premium' ? 'é«˜ç´šæœƒå“¡' : 'æ™®é€šæœƒå“¡'}
          </p>
        </div>
        <div class="stat-card glass rounded-lg p-4">
          <h3 class="text-sm text-gray-500">æœ€å¾Œç™»å…¥</h3>
          <p class="text-2xl font-bold">{formatDate(user.lastLogin)}</p>
        </div>
        <div class="stat-card glass rounded-lg p-4">
          <h3 class="text-sm text-gray-500">å¸³æˆ¶å¹´é½¡</h3>
          <p class="text-2xl font-bold">{calculateAccountAge()} å¤©</p>
        </div>
      </section>

      {/* è©³ç´°è³‡è¨Š */}
      <section class="details glass rounded-lg p-6 mb-6">
        <h2 class="text-xl font-bold mb-4">å¸³æˆ¶è©³æƒ…</h2>
        <div class="space-y-4">
          <div class="detail-item flex justify-between py-3 border-b border-gray-200 dark:border-gray-700">
            <span class="label font-semibold text-gray-600 dark:text-gray-400">ä½¿ç”¨è€… ID</span>
            <span class="value text-gray-900 dark:text-gray-100">{user.id}</span>
          </div>
          <div class="detail-item flex justify-between py-3 border-b border-gray-200 dark:border-gray-700">
            <span class="label font-semibold text-gray-600 dark:text-gray-400">è§’è‰²</span>
            <span class="value text-gray-900 dark:text-gray-100">{formatRole(user.role)}</span>
          </div>
          <div class="detail-item flex justify-between py-3 border-b border-gray-200 dark:border-gray-700">
            <span class="label font-semibold text-gray-600 dark:text-gray-400">åŠ å…¥æ—¥æœŸ</span>
            <span class="value text-gray-900 dark:text-gray-100">{formatFullDate(user.joinDate)}</span>
          </div>
          <div class="detail-item flex justify-between py-3">
            <span class="label font-semibold text-gray-600 dark:text-gray-400">æœ€å¾Œç™»å…¥</span>
            <span class="value text-gray-900 dark:text-gray-100">{formatFullDate(user.lastLogin)}</span>
          </div>
        </div>
      </section>

      {/* æ¬Šé™é é¢ */}
      <section class="permissions glass rounded-lg p-6 mb-6">
        <h2 class="text-xl font-bold mb-4">æ‚¨å¯ä»¥å­˜å–çš„åŠŸèƒ½</h2>
        <div class="space-y-3">
          <div class="permission-item flex items-center gap-3 p-3 rounded bg-green-50 dark:bg-green-900/20">
            <span class="icon text-lg">âœ“</span>
            <span>å€‹äººè³‡æ–™ç®¡ç†</span>
          </div>
          <div class={`permission-item flex items-center gap-3 p-3 rounded ${user.role === 'premium' ? 'bg-green-100 dark:bg-green-900/40' : 'bg-green-50 dark:bg-green-900/20'}`}>
            <span class="icon text-lg">{user.role === 'premium' ? 'âœ“' : 'ğŸ”’'}</span>
            <span>æˆ‘çš„æ”¶è— ({user.role === 'premium' ? 'å·²è§£é–' : 'é«˜ç´šåŠŸèƒ½'})</span>
          </div>
          <div class={`permission-item flex items-center gap-3 p-3 rounded ${user.role === 'premium' ? 'bg-green-100 dark:bg-green-900/40' : 'bg-green-50 dark:bg-green-900/20'}`}>
            <span class="icon text-lg">{user.role === 'premium' ? 'âœ“' : 'ğŸ”’'}</span>
            <span>é€²åº¦è¿½è¹¤ ({user.role === 'premium' ? 'å·²è§£é–' : 'é«˜ç´šåŠŸèƒ½'})</span>
          </div>
          <div class={`permission-item flex items-center gap-3 p-3 rounded ${user.role === 'admin' ? 'bg-green-100 dark:bg-green-900/40' : 'bg-green-50 dark:bg-green-900/20'}`}>
            <span class="icon text-lg">{user.role === 'admin' ? 'âœ“' : 'ğŸ”’'}</span>
            <span>ç®¡ç†å¾Œå° ({user.role === 'admin' ? 'å·²è§£é–' : 'åƒ…é™ç®¡ç†å“¡'})</span>
          </div>
        </div>
      </section>

      {/* æ“ä½œæŒ‰éˆ• */}
      <section class="actions flex gap-4 justify-center">
        <button onclick="handleLogout()" class="btn btn-danger">ç™»å‡º</button>
        <a href="/" class="btn btn-secondary">è¿”å›é¦–é </a>
      </section>
    </div>
  ) : null}
</div>

<script>
const handleLogout = () => {
  localStorage.removeItem('auth_token');
  localStorage.removeItem('user_info');
  window.location.href = '/';
};
</script>

<style>
.profile-container {
  @apply section container;
}

.not-logged-in {
  @apply glass rounded-lg p-8 text-center;
}

.badge {
  @apply inline-block px-3 py-1 rounded-full text-sm font-semibold;
}

.btn {
  @apply px-4 py-2 rounded-lg font-semibold transition-colors;
}

.btn-primary {
  @apply bg-blue-500 text-white hover:bg-blue-600;
}

.btn-secondary {
  @apply bg-gray-500 text-white hover:bg-gray-600;
}

.btn-danger {
  @apply bg-red-500 text-white hover:bg-red-600;
}

.actions {
  @apply justify-center;
}
</style>
